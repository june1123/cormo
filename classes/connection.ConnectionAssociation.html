<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CORMO - connection.ConnectionAssociation</title><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><div class="navbar navbar-default navbar-fixed-top"><div class="container-fluid"><ul class="nav navbar-nav"><li><a href="../index.html">Home</a></li><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle">Guides <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/Association.html">Association</a></li><li><a href="../guides/Callback.html">Callback</a></li><li><a href="../guides/CLI.html">Cli</a></li><li><a href="../guides/Constraint.html">Constraint</a></li><li><a href="../guides/CreateRecords.html">Create records</a></li><li><a href="../guides/DefineModels.html">Define models</a></li><li><a href="../guides/Geospatial.html">Geospatial</a></li><li><a href="../guides/Miscellaneous.html">Miscellaneous</a></li><li><a href="../guides/Query.html">Query</a></li><li><a href="../guides/Validation.html">Validation</a></li></ul></li><li><a href="../modules/index.html">Modules</a></li><li class="active"><a href="../classes/index.html">Classes - connection.ConnectionAssociation</a></li><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle">Files <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/command.coffee.html">command.coffee</a></li><li><a href="../files/connection.coffee.html">connection.coffee</a></li><li><a href="../files/console.coffee.html">console.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/inflector.coffee.html">inflector.coffee</a></li><li><a href="../files/model.coffee.html">model.coffee</a></li><li><a href="../files/query.coffee.html">query.coffee</a></li><li><a href="../files/types.coffee.html">types.coffee</a></li><li><a href="../files/util.coffee.html">util.coffee</a></li><li><a href="../files/adapters.base.coffee.html">adapters/base.coffee</a></li><li><a href="../files/adapters.mongodb.coffee.html">adapters/mongodb.coffee</a></li><li><a href="../files/adapters.mysql.coffee.html">adapters/mysql.coffee</a></li><li><a href="../files/adapters.postgresql.coffee.html">adapters/postgresql.coffee</a></li><li><a href="../files/adapters.redis.coffee.html">adapters/redis.coffee</a></li><li><a href="../files/adapters.sql_base.coffee.html">adapters/sql_base.coffee</a></li><li><a href="../files/adapters.sqlite3.coffee.html">adapters/sqlite3.coffee</a></li><li><a href="../files/adapters.sqlite3_memory.coffee.html">adapters/sqlite3_memory.coffee</a></li><li><a href="../files/command.console.coffee.html">command/console.coffee</a></li><li><a href="../files/command.remote-console.coffee.html">command/remote-console.coffee</a></li><li><a href="../files/connection.association.coffee.html">connection/association.coffee</a></li><li><a href="../files/connection.manipulate.coffee.html">connection/manipulate.coffee</a></li><li><a href="../files/model.cache.coffee.html">model/cache.coffee</a></li><li><a href="../files/model.callback.coffee.html">model/callback.coffee</a></li><li><a href="../files/model.persistence.coffee.html">model/persistence.coffee</a></li><li><a href="../files/model.query.coffee.html">model/query.coffee</a></li><li><a href="../files/model.timestamp.coffee.html">model/timestamp.coffee</a></li><li><a href="../files/model.validate.coffee.html">model/validate.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private </label></div></div></div><div class="container-fluid content"><div class="row"><div data-spy="affix" class="hidden-xs sidebar col-sm-3"><div class="cormo-sidenav"><div class="panel panel-default"><div id="undefined_body" class="panel-collapse collapse in"><ul class="nav nav-pills nav-stacked"><li><a href="../classes/ColumnProperty.html">ColumnProperty</a></li><li><a href="../classes/Command.html">Command</a></li><li><a href="../classes/CommandConsole.html">CommandConsole</a></li><li><a href="../classes/CommandRemoteConsole.html">CommandRemoteConsole</a></li><li><a href="../classes/Connection.html">Connection</a></li><li><a href="../classes/Model.html">Model</a></li><li><a href="../classes/Query.html">Query</a></li></ul></div></div><div class="panel panel-default"><div data-toggle="collapse" data-target="#adapter_body" class="panel-heading">adapter<span class="pull-right glyphicon"></span></div><div id="adapter_body" class="panel-collapse collapse in"><ul class="nav nav-pills nav-stacked"><li><a href="../classes/adapter.AdapterBase.html">AdapterBase</a></li><li><a href="../classes/adapter.MongoDBAdapter.html">MongoDBAdapter</a></li><li><a href="../classes/adapter.MySQLAdapter.html">MySQLAdapter</a></li><li><a href="../classes/adapter.PostgreSQLAdapter.html">PostgreSQLAdapter</a></li><li><a href="../classes/adapter.RedisAdapter.html">RedisAdapter</a></li><li><a href="../classes/adapter.SQLAdapterBase.html">SQLAdapterBase</a></li><li><a href="../classes/adapter.SQLite3Adapter.html">SQLite3Adapter</a></li></ul></div></div><div class="panel panel-default"><div data-toggle="collapse" data-target="#connection_body" class="panel-heading">connection<span class="pull-right glyphicon"></span></div><div id="connection_body" class="panel-collapse collapse in"><ul class="nav nav-pills nav-stacked"><li class="active"><a href="#connection_ConnectionAssociation">ConnectionAssociation</a></li><li class="cormo-class-property private"><a href="#connection_ConnectionAssociation___applyAssociations">_applyAssociations<span class="pull-right label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#connection_ConnectionAssociation___belongsTo">_belongsTo<span class="pull-right label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#connection_ConnectionAssociation___hasMany">_hasMany<span class="pull-right label label-private">private</span></a></li><li class="cormo-class-property private"><a href="#connection_ConnectionAssociation___hasOne">_hasOne<span class="pull-right label label-private">private</span></a></li><li class="cormo-class-property"><a href="#connection_ConnectionAssociation__addAssociation">addAssociation</a></li><li class="cormo-class-property"><a href="#connection_ConnectionAssociation__fetchAssociated">fetchAssociated</a></li><li class="cormo-class-property"><a href="#connection_ConnectionAssociation__getInconsistencies">getInconsistencies</a></li><li><a href="../classes/connection.ConnectionManipulate.html">ConnectionManipulate</a></li></ul></div></div><div class="panel panel-default"><div data-toggle="collapse" data-target="#model_body" class="panel-heading">model<span class="pull-right glyphicon"></span></div><div id="model_body" class="panel-collapse collapse in"><ul class="nav nav-pills nav-stacked"><li><a href="../classes/model.ModelCache.html">ModelCache</a></li><li><a href="../classes/model.ModelCallback.html">ModelCallback</a></li><li><a href="../classes/model.ModelPersistence.html">ModelPersistence</a></li><li><a href="../classes/model.ModelQuery.html">ModelQuery</a></li><li><a href="../classes/model.ModelTimestamp.html">ModelTimestamp</a></li><li><a href="../classes/model.ModelValidate.html">ModelValidate</a></li></ul></div></div><div class="panel panel-default"><div data-toggle="collapse" data-target="#ptypes_body" class="panel-heading">ptypes<span class="pull-right glyphicon"></span></div><div id="ptypes_body" class="panel-collapse collapse in"><ul class="nav nav-pills nav-stacked"><li><a href="../classes/ptypes.GeoPoint.html">GeoPoint</a></li><li><a href="../classes/ptypes.Integer.html">Integer</a></li><li><a href="../classes/ptypes.RecordID.html">RecordID</a></li></ul></div></div></div></div><div class="col-sm-9 col-sm-offset-3"><span id="connection_ConnectionAssociation" class="fix-anchor"></span><section><h1 class="class_title">ConnectionAssociation</h1><div><p>Makes association between two models</p>
</div><div></div><dl><dt>Used by:</dt><dd><a href='../classes/Connection.html#Connection'>Connection</a></dd></dl><div class="showcode"><button class="btn btn-info">Show class code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L10">/src/connection/association.coffee:10</a>)</span></div><pre class="sourcecode prettyprint .linenums:10">class ConnectionAssociation</pre><div class="panel panel-info"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation_ctor_body" class="panel-heading collapsed"><h3 class="panel-title">Constructor<span class="pull-right glyphicon"></span></h3></div><div id="connection_ConnectionAssociation_ctor_body" class="panel-collapse collapse"><div class="panel-body"><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><td>(None)</td></tr></table></div></div></div></section><span id="connection_ConnectionAssociation___applyAssociations" class="fix-anchor"></span><section class="private"><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation___applyAssociations_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::_applyAssociations(connection, associations)<span class="label label-private">private</span><span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Applies pending associations</p>
</div></div><div id="connection_ConnectionAssociation___applyAssociations_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>connection</code></td><td><span><a href='../classes/Connection.html#Connection'>Connection</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>associations</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array'>Array</a>&lt;<a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>type</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> 'hasMany' or 'belongsTo'</span></td></tr></table><h4>Returns</h4><table class="table table-bordered table-condensed table-hover"><tr><td>(Nothing)</td></tr></table><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L188">/src/connection/association.coffee:188</a>)</span></div><pre class="sourcecode prettyprint .linenums:188">_applyAssociations: -&gt;
  @_pending_associations.forEach (item) =&gt;
    this_model = item.this_model
    options = item.options
    if typeof item.target_model_or_column is 'string'
      if item.options?.connection
        models = item.options.connection.models
      else
        models = @models
      if item.options?.type
        target_model = item.options.type
        options.as = item.target_model_or_column
      else if item.type is 'belongsTo' or item.type is 'hasOne'
        target_model = inflector.camelize item.target_model_or_column
      else
        target_model = inflector.classify item.target_model_or_column
      throw new Error(&quot;model #{target_model} does not exist&quot;) if not models[target_model]
      target_model = models[target_model]
    else
      target_model = item.target_model_or_column
    @['_'+item.type] this_model, target_model, options

  @_pending_associations = []</pre></div></div></div></section><span id="connection_ConnectionAssociation___belongsTo" class="fix-anchor"></span><section class="private"><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation___belongsTo_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::_belongsTo(this_model, target_model, [options])<span class="label label-private">private</span><span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Adds a belongs-to association</p>
</div></div><div id="connection_ConnectionAssociation___belongsTo_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>this_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>target_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>options</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>as</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>foreign_key</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr></table><h4>Returns</h4><table class="table table-bordered table-condensed table-hover"><tr><td>(Nothing)</td></tr></table><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L140">/src/connection/association.coffee:140</a>)</span></div><pre class="sourcecode prettyprint .linenums:140">_belongsTo: (this_model, target_model, options) -&gt;
  if options?.foreign_key
    foreign_key = options.foreign_key
  else if options?.as
    foreign_key = options.as + '_id'
  else
    foreign_key = inflector.foreign_key target_model._name
  this_model.column foreign_key, type: types.RecordID, connection: target_model._connection, required: options?.required

  column = options?.as or inflector.underscore(target_model._name)
  columnCache = '__cache_' + column
  columnGetter = '__getter_' + column

  this_model._associations[column] = { type: 'belongsTo', target_model: target_model }

  Object.defineProperty this_model.prototype, column,
    get: -&gt;
      # getter must be created per instance due to __scope
      if not @.hasOwnProperty columnGetter
        getter = (reload, callback) -&gt;
          if typeof reload is 'function'
            callback = reload
            reload = false
          # @ is getter.__scope in normal case (this_model_instance.target_model_name()),
          # but use getter.__scope for safety
          Promise.resolve()
          .then -&gt;
            self = getter.__scope
            if (not self[columnCache] or reload) and self[foreign_key]
              target_model.find self[foreign_key]
              .exec()
              .then (record) -&gt;
                self[columnCache] = record
                Promise.resolve record
            else
              Promise.resolve self[columnCache]
          .nodeify callback
        getter.__scope = @
        Object.defineProperty @, columnCache, value: null, writable: true
        Object.defineProperty @, columnGetter, value: getter
      return @[columnGetter]</pre></div></div></div></section><span id="connection_ConnectionAssociation___hasMany" class="fix-anchor"></span><section class="private"><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation___hasMany_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::_hasMany(this_model, target_model, [options])<span class="label label-private">private</span><span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Adds a has-many association</p>
</div></div><div id="connection_ConnectionAssociation___hasMany_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>this_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>target_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>options</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>as</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>foreign_key</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>integrity='ignore'</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> 'ignore', 'nullify'</span></td></tr></table><h4>Returns</h4><table class="table table-bordered table-condensed table-hover"><tr><td>(Nothing)</td></tr></table><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L20">/src/connection/association.coffee:20</a>)</span></div><pre class="sourcecode prettyprint .linenums:20">_hasMany: (this_model, target_model, options) -&gt;
  if options?.foreign_key
    foreign_key = options.foreign_key
  else if options?.as
    foreign_key = options.as + '_id'
  else
    foreign_key = inflector.foreign_key this_model._name
  target_model.column foreign_key, type: types.RecordID, connection: this_model._connection

  integrity = options?.integrity or 'ignore'
  target_model._integrities.push type: 'child_'+integrity, column: foreign_key, parent: this_model
  this_model._integrities.push type: 'parent_'+integrity, column: foreign_key, child: target_model

  column = options?.as or inflector.tableize(target_model._name)
  columnCache = '__cache_' + column
  columnGetter = '__getter_' + column

  this_model._associations[column] = { type: 'hasMany', target_model: target_model, foreign_key: foreign_key }

  Object.defineProperty this_model.prototype, column,
    get: -&gt;
      # getter must be created per instance due to __scope
      if not @.hasOwnProperty columnGetter
        getter = (reload, callback) -&gt;
          if typeof reload is 'function'
            callback = reload
            reload = false
          # @ is getter.__scope in normal case (this_model_instance.target_model_name()),
          # but use getter.__scope for safety
          Promise.resolve()
          .then -&gt;
            self = getter.__scope
            if (not self[columnCache] or reload) and self.id
              conditions = {}
              conditions[foreign_key] = self.id
              target_model.where conditions
              .exec()
              .then (records) -&gt;
                self[columnCache] = records
                Promise.resolve records
            else
              Promise.resolve self[columnCache] or []
          .nodeify callback
        getter.build = (data) -&gt;
          # @ is getter, so use getter.__scope instead
          self = getter.__scope
          new_object = new target_model data
          new_object[foreign_key] = self.id
          self[columnCache] = [] if not self[columnCache]
          self[columnCache].push new_object
          return new_object
        getter.__scope = @
        Object.defineProperty @, columnCache, value: null, writable: true
        Object.defineProperty @, columnGetter, value: getter
      return @[columnGetter]</pre></div></div></div></section><span id="connection_ConnectionAssociation___hasOne" class="fix-anchor"></span><section class="private"><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation___hasOne_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::_hasOne(this_model, target_model, [options])<span class="label label-private">private</span><span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Adds a has-one association</p>
</div></div><div id="connection_ConnectionAssociation___hasOne_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>this_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>target_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>options</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> </span></td></tr></table><h4>Returns</h4><table class="table table-bordered table-condensed table-hover"><tr><td>(Nothing)</td></tr></table><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L82">/src/connection/association.coffee:82</a>)</span></div><pre class="sourcecode prettyprint .linenums:82">_hasOne: (this_model, target_model, options) -&gt;
  if options?.foreign_key
    foreign_key = options.foreign_key
  else if options?.as
    foreign_key = options.as + '_id'
  else
    foreign_key = inflector.foreign_key this_model._name
  target_model.column foreign_key, type: types.RecordID, connection: this_model._connection

  integrity = options?.integrity or 'ignore'
  target_model._integrities.push type: 'child_'+integrity, column: foreign_key, parent: this_model
  this_model._integrities.push type: 'parent_'+integrity, column: foreign_key, child: target_model

  column = options?.as or inflector.underscore(target_model._name)
  columnCache = '__cache_' + column
  columnGetter = '__getter_' + column

  this_model._associations[column] = { type: 'hasOne', target_model: target_model }

  Object.defineProperty this_model.prototype, column,
    get: -&gt;
      # getter must be created per instance due to __scope
      if not @.hasOwnProperty columnGetter
        getter = (reload, callback) -&gt;
          if typeof reload is 'function'
            callback = reload
            reload = false
          # @ is getter.__scope in normal case (this_model_instance.target_model_name()),
          # but use getter.__scope for safety
          Promise.resolve()
          .then -&gt;
            self = getter.__scope
            if (not self[columnCache] or reload) and self.id
              conditions = {}
              conditions[foreign_key] = self.id
              target_model.where conditions
              .exec()
              .then (records) -&gt;
                return Promise.reject new Error('integrity error') if records.length &gt; 1
                record = if records.length is 0 then null else records[0]
                self[columnCache] = record
                Promise.resolve record
            else
              Promise.resolve self[columnCache]
          .nodeify callback
        getter.__scope = @
        Object.defineProperty @, columnCache, value: null, writable: true
        Object.defineProperty @, columnGetter, value: getter
      return @[columnGetter]</pre></div></div></div></section><span id="connection_ConnectionAssociation__addAssociation" class="fix-anchor"></span><section><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation__addAssociation_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::addAssociation(association)<span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Adds an association</p>
</div></div><div id="connection_ConnectionAssociation__addAssociation_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>association</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>type</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> 'hasMany' or 'belongsTo'</span></td></tr><tr><td><span class="method-depth1"></span><code>this_model</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>target_model_or_column</code></td><td><span><a href='http://coffeescript.org/#classes'>Class</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;, <a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth1"></span><code>options</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth2"></span><code>type</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth2"></span><code>as</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth2"></span><code>foreign_key</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr></table><h4>Returns</h4><table class="table table-bordered table-condensed table-hover"><tr><td>(Nothing)</td></tr></table><h4>See Also:</h4><ul><li><a href='../classes/Model.html#Model_hasMany'>Model.hasMany</a></li><li><a href='../classes/Model.html#Model_belongsTo'>Model.belongsTo</a></li></ul><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L224">/src/connection/association.coffee:224</a>)</span></div><pre class="sourcecode prettyprint .linenums:224">addAssociation: (association) -&gt;
  @_pending_associations.push association
  @_schema_changed = true</pre></div></div></div></section><span id="connection_ConnectionAssociation__fetchAssociated" class="fix-anchor"></span><section><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation__fetchAssociated_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::fetchAssociated(records, column, [select], [options], [callback])<span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Fetches associated records</p>
</div></div><div id="connection_ConnectionAssociation__fetchAssociated_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>records</code></td><td><span><a href='../classes/Model.html#Model'>Model</a>, <a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array'>Array</a>&lt;<a href='../classes/Model.html#Model'>Model</a>&gt;</span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>column</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>select</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/String'>String</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>options</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> </span></td></tr><tr><td><span class="method-depth0"></span><code>callback</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function'>Function</a>(error)</span></td><td><span> NodeJS style's callback</span></td></tr><tr><td><span class="method-depth1"></span><code>error</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error'>Error</a></span></td><td><span> See throws</span></td></tr></table><h4>Returns<small><span> as</span><span class="label label-info">Promise</span><span class="label label-info">NodeJS callback</span></small></h4><table class="table table-bordered table-condensed table-hover"><tr><td>(Nothing)</td></tr></table><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L366">/src/connection/association.coffee:366</a>)</span></div><pre class="sourcecode prettyprint .linenums:366">fetchAssociated: (records, column, select, options, callback) -&gt;
  if typeof select is 'function'
    callback = select
    options = {}
    select = null
  else if typeof options is 'function'
    callback = options
    options = {}
    if typeof select is 'object'
      options = select
      select = null

  @_checkSchemaApplied().then =&gt;
    record = if Array.isArray records then records[0] else records
    return Promise.resolve() if not record
    if options.target_model
      association = type: options.type or 'belongsTo', target_model: options.target_model, foreign_key: options.foreign_key
    else if options.model
      association = options.model._associations?[column]
    else
      association = record.constructor._associations?[column]
    return Promise.reject new Error(&quot;unknown column '#{column}'&quot;) if not association
    if association.type is 'belongsTo'
      @_fetchAssociatedBelongsTo records, association.target_model, column, select, options
    else if association.type is 'hasMany'
      @_fetchAssociatedHasMany records, association.target_model, association.foreign_key, column, select, options
    else
      Promise.reject new Error(&quot;unknown column '#{column}'&quot;)
  .nodeify bindDomain callback</pre></div></div></div></section><span id="connection_ConnectionAssociation__getInconsistencies" class="fix-anchor"></span><section><div class="panel panel-success"><div data-toggle="collapse" data-target="#connection_ConnectionAssociation__getInconsistencies_body" class="panel-heading collapsed"><h3 class="panel-title">ConnectionAssociation::getInconsistencies([callback])<span class="pull-right glyphicon"></span></h3><div class="method-summary"><p>Returns inconsistent records against associations</p>
</div></div><div id="connection_ConnectionAssociation__getInconsistencies_body" class="panel-collapse collapse"><div class="panel-body"><div></div><h4>Parameters</h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td><span class="method-depth0"></span><code>callback</code><span class="pull-right label label-optional">optional</span></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function'>Function</a>(error, result)</span></td><td><span> NodeJS style's callback</span></td></tr><tr><td><span class="method-depth1"></span><code>error</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Error'>Error</a></span></td><td><span> See throws</span></td></tr><tr><td><span class="method-depth1"></span><code>result</code></td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span> See returns</span></td></tr></table><h4>Returns<small><span> as</span><span class="label label-info">Promise</span><span class="label label-info">NodeJS callback</span></small></h4><table class="table table-bordered table-condensed table-hover"><tr><th>Name</th><th>Type</th><th>Description</th></tr><tr><td>(Returns)</td><td><span><a href='https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object'>Object</a></span></td><td><span>Hash of model name to Array of RecordIDs</span></td></tr></table><div class="showcode"><button class="btn btn-info">Show code</button><span> (defined in <a href="https://github.com/croquiscom/cormo/blob/master//src/connection/association.coffee#L233">/src/connection/association.coffee:233</a>)</span></div><pre class="sourcecode prettyprint .linenums:233">getInconsistencies: (callback) -&gt;
  @_checkSchemaApplied().then =&gt;
    result = {}
    promises = Object.keys(@models).map (model) =&gt;
      modelClass = @models[model]
      integrities = modelClass._integrities.filter (integrity) -&gt; integrity.type.substr(0, 7) is 'parent_'
      if integrities.length &gt; 0
        modelClass.select ''
        .exec()
        .then (records) =&gt;
          ids = records.map (record) -&gt; record.id
          sub_promises = integrities.map (integrity) =&gt;
            query = integrity.child.select ''
            conditions = {}
            conditions[integrity.column] = $not: $in: ids
            query.where(conditions)
            property = integrity.child._schema[integrity.column]
            if not property.required
              conditions = {}
              conditions[integrity.column] = $not: null
              query.where(conditions)
            query.exec()
            .then (records) -&gt;
              if records.length &gt; 0
                array = result[integrity.child._name] ||= []
                [].push.apply array, records.map (record) -&gt; record.id
                _.uniq array
          Promise.all sub_promises
      else
        Promise.resolve()
    Promise.all promises
    .then -&gt;
      Promise.resolve result
  .nodeify callback</pre></div></div></div></section></div></div></div><script src="http://code.jquery.com/jquery-1.11.0.min.js"></script><script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script src="../script.js"></script><a href="https://github.com/croquiscom/cormo"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub" class="github-ribbon"></a></body></html>