<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CORMO - Query</title><script>if (location.protocol.match(/^http/) && location.pathname.match('\.html') === null && location.pathname.slice(-1) !== '/') {
  location.href = location.href + '/';
}</script><link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="../bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"><link href="../google-code-prettify/prettify.css" rel="stylesheet" type="text/css"><link href="../style.css" rel="stylesheet" type="text/css"><link href="../tocify/jquery.tocify.css" rel="stylesheet" type="text/css"></head><body data-spy="scroll" data-target=".sidebar"><div class="navbar navbar-inverse navbar-fixed-top"><div class="navbar-inner"><div class="container-fluid"><ul class="nav"><li><a href="../index.html">Home</a></li><li class="dropdown active"><a data-toggle="dropdown" href="#" class="dropdown-toggle">Guides - Query <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../guides/Association.html">Association</a></li><li><a href="../guides/CLI.html">CLI</a></li><li><a href="../guides/Callback.html">Callback</a></li><li><a href="../guides/Constraint.html">Constraint</a></li><li><a href="../guides/CreateRecords.html">CreateRecords</a></li><li><a href="../guides/DefineModels.html">DefineModels</a></li><li><a href="../guides/Geospatial.html">Geospatial</a></li><li><a href="../guides/Miscellaneous.html">Miscellaneous</a></li><li><a href="../guides/Query.html">Query</a></li><li><a href="../guides/Validation.html">Validation</a></li></ul></li><li><a href="../modules/cormo.html">Modules</a></li><li><a href="../classes/ColumnProperty.html">Classes</a></li><li class="dropdown"><a data-toggle="dropdown" href="#" class="dropdown-toggle">Files <span class="caret"></span></a><ul class="dropdown-menu"><li><a href="../files/command.coffee.html">command.coffee</a></li><li><a href="../files/connection.coffee.html">connection.coffee</a></li><li><a href="../files/console_future.coffee.html">console_future.coffee</a></li><li><a href="../files/index.coffee.html">index.coffee</a></li><li><a href="../files/inflector.coffee.html">inflector.coffee</a></li><li><a href="../files/model.coffee.html">model.coffee</a></li><li><a href="../files/query.coffee.html">query.coffee</a></li><li><a href="../files/types.coffee.html">types.coffee</a></li><li><a href="../files/util.coffee.html">util.coffee</a></li><li><a href="../files/adapters.base.coffee.html">adapters/base.coffee</a></li><li><a href="../files/adapters.mongodb.coffee.html">adapters/mongodb.coffee</a></li><li><a href="../files/adapters.mysql.coffee.html">adapters/mysql.coffee</a></li><li><a href="../files/adapters.postgresql.coffee.html">adapters/postgresql.coffee</a></li><li><a href="../files/adapters.redis.coffee.html">adapters/redis.coffee</a></li><li><a href="../files/adapters.sql_base.coffee.html">adapters/sql_base.coffee</a></li><li><a href="../files/adapters.sqlite3.coffee.html">adapters/sqlite3.coffee</a></li><li><a href="../files/adapters.sqlite3_memory.coffee.html">adapters/sqlite3_memory.coffee</a></li><li><a href="../files/command.console.coffee.html">command/console.coffee</a></li><li><a href="../files/connection.association.coffee.html">connection/association.coffee</a></li><li><a href="../files/connection.manipulate.coffee.html">connection/manipulate.coffee</a></li><li><a href="../files/model.cache.coffee.html">model/cache.coffee</a></li><li><a href="../files/model.callback.coffee.html">model/callback.coffee</a></li><li><a href="../files/model.persistence.coffee.html">model/persistence.coffee</a></li><li><a href="../files/model.query.coffee.html">model/query.coffee</a></li><li><a href="../files/model.timestamp.coffee.html">model/timestamp.coffee</a></li><li><a href="../files/model.validate.coffee.html">model/validate.coffee</a></li></ul></li></ul><div class="options"><label class="checkbox"><input id="options-private" type="checkbox"> Private </label></div></div></div></div><div class="container-fluid content extra"><div class="row-fluid"><div class="span3"><div id="toc"></div></div><div class="span9"><p>To query, create a query object using <a href='../classes/model.ModelQuery.html#model_ModelQuery_query'>ModelQuery.query</a> first.
Then build up a query by chaining methods,
and run a query by <a href='../classes/Query.html#Query__exec'>Query::exec</a>, <a href='../classes/Query.html#Query__count'>Query::count</a>, <a href='../classes/Query.html#Query__update'>Query::update</a>, or <a href='../classes/Query.html#Query__delete'>Query::delete</a>.</p>
<p>Also, <a href='../classes/model.ModelQuery.html#model_ModelQuery'>ModelQuery</a> class has some methods that borrowed from <a href='../classes/Query.html#Query'>Query</a> to run simple queries easily.</p>
<pre><code>User.query().where(age: 27).exec (error, users) -&gt;
  console.log users

User.where(age: 27).exec (error, users) -&gt;
  console.log users

User.where age:27, (error, users) -&gt;
  console.log users
</code></pre><h1 id="selection-criteria">Selection criteria</h1>
<p>You can give criteria for selection with <a href='../classes/Query.html#Query__where'>Query::where</a> or <a href='../classes/Query.html#Query__find'>Query::find</a>.
<a href='../classes/Query.html#Query__where'>Query::where</a>&#39;s criteria is similar to the MongoDB&#39;s.
Two or more <a href='../classes/Query.html#Query__where'>Query::where</a>s mean a logical and.</p>
<table class='table table-bordered'><thead><tr>
  <th>Description</th><th>CORMO</th><th>SQL</th><th>MongoDB</th>
</tr></thead><tbody>

<tr>
<td>Equal</td>
<td>User.where(age: 27).exec (error, users) -&gt;</td>
<td>SELECT * FROM users WHERE age=27</td>
<td>db.users.find({age: 27})</td>
</tr>

<tr>
<td rowspan='4'>Logical and</td>
<td>name: &#39;John Doe&#39;, age: 27</td>
<td rowspan='4'>name=&#39;John Doe&#39; AND age=27</td>
<td rowspan='4'>{ name: &#39;John Doe&#39;, age: 27 }</td>
</tr>
<tr>
<td>.where(name: &#39;John Doe&#39;).where(age: 27)</td>
</tr>
<tr>
<td>$and: [ { name: &#39;John Doe&#39; }, { age: 27 } ]</td>
</tr>
<tr>
<td>[ { name: &#39;John Doe&#39; }, { age: 27 } ]</td>
</tr>

<tr>
<td>Logical or</td>
<td>$or: [ { name: &#39;John Doe&#39; }, { age: 27 } ]</td>
<td>name=&#39;John Doe&#39; OR age=27</td>
<td>{ $or: [ { name: &#39;John Doe&#39; }, { age: 27 } ] }</td>
</tr>

<tr>
<td>Comparison ($lt, $gt, $lte, $gte)</td>
<td>[ { age: { $gt: 30 } }, { age: { $lte: 45 } } ]</td>
<td>age&gt;30 AND age&lt;=45</td>
<td>{ $and: [ { age: { $gt: 30 } }, { age: { $lte: 45 } } ] }</td>
</tr>

<tr>
<td>Containing some text in case insensitive</td>
<td>name: { $contains: &#39;smi&#39; }</td>
<td>name LIKE &#39;%smi%&#39;</td>
<td>{ name: /smi/i }</td>
</tr>

<tr>
<td rowspan='2'>Matches any of an array</td>
<td>age: { $in: [ 10, 20, 30 ] }</td>
<td rowspan='2'>age IN (10,20,30)</td>
<td rowspan='2'>{ age: { $in: [ 10, 20, 30 ] } }</td>
</tr>
<tr>
<td>age: [ 10, 20, 30 ]</td>
</tr>

<tr>
<td rowspan='6'>Logical not</td>
<td>age: $not: 27</td>
<td>NOT (age=27) OR age IS NULL</td>
<td>{ age: { $ne: 27 } }</td>
</tr>
<tr>
<td>age: $not: $lt: 27</td>
<td>NOT (age<27) OR age IS NULL</td>
<td>{ age: { $not: { $lt: 27 } } }</td>
</tr>
<tr>
<td>name: $not: $contains: &#39;smi&#39;</td>
<td>NOT (name LIKE &#39;%smi%&#39;) OR name IS NULL</td>
<td>{ name: { $not: /smi/i } }</td>
</tr>
<tr>
<td>age: $not: $in: [ 10, 20, 30 ]</td>
<td rowspan='2'>NOT (age IN (10,20,30)) OR age IS NULL</td>
<td rowspan='2'>{ age: { $nin: [10,20,30] } }</td>
</tr>
<tr>
<td>age: $not: [ 10, 20, 30 ]</td>
</tr>
<tr>
<td>name: $not: null</td>
<td>NOT name IS NULL</td>
<td>{ age: { $ne: null } }</td>
</tr>

</tbody></table>

<p>If you want find records based on the identifier, use <a href='../classes/Query.html#Query__find'>Query::find</a> that accepts an ID or an array of IDs.
It is logically same to &#39;.where(id: &lt;given ID or array of IDs&gt;)&#39;.</p>
<h1 id="retrieve-records">Retrieve records</h1>
<p><a href='../classes/Query.html#Query__exec'>Query::exec</a> retrieves records. </p>
<p>It normally returns an array of Model instances.
But if you use <a href='../classes/Query.html#Query__find'>Query::find</a> for a single ID, it will return a single Model instance.</p>
<pre><code class="lang-coffeescript">User.find 1, (error, user) -&gt;
  console.log user

User.find [1,2,3], (error, users) -&gt;
  console.log users
</code></pre>
<p><a href='../classes/Query.html#Query__find'>Query::find</a> does not return error if any ID is found and does not preserve given order.
If you want to guarantee that you get all records of IDs and order is preserved,
use <a href='../classes/Query.html#Query__findPreserve'>Query::findPreserve</a> instead.</p>
<pre><code class="lang-coffeescript">User.findPreserve [2,1,2,3], (error, users) -&gt;
  # users[0].id is 2 and users[1].id is 1 and users[2].id is 2 and users[3].id is 3
</code></pre>
<p>You can give some options to <a href='../classes/Query.html#Query__exec'>Query::exec</a>.</p>
<table class='table table-bordered'><thead><tr>
  <th>Description</th><th>CORMO</th><th>SQL</th><th>MongoDB</th>
</tr></thead><tbody>

<tr>
<td>Projection</td>
<td>User.select(&#39;name age&#39;).exec</td>
<td>SELECT id,name,age FROM users</td>
<td>db.users.find({}, { name: 1, age: 1 })</td>
</tr>

<tr>
<td>Sort</td>
<td>User.order(&#39;age -name&#39;).exec</td>
<td>SELECT * FROM users ORDER BY age ASC, name DESC</td>
<td>db.users.find().sort({ age: 1, name: -1 })</td>
</tr>

<tr>
<td>Limit</td>
<td>User.query().limit(3).exec</td>
<td>SELECT * FROM users LIMIT 3</td>
<td>db.users.find().limit(3)</td>
</tr>

<tr>
<td>Skip</td>
<td>User.query().skip(3).exec</td>
<td>SELECT * FROM users LIMIT 2147483647 OFFSET 3</td>
<td>db.users.find().skip(3)</td>
</tr>

</tbody></table>

<h2 id="request-only-one-record">Request only one record</h2>
<p>If you know that there will be only one result (e.x. query on unique column), <a href='../classes/Query.html#Query__one'>Query::one</a> will be helpful.
It makes a query return a single instance (or null) instead of array of instances.</p>
<pre><code>User.where(age: 27).one().exec (error, user) -&gt;
  console.log user
</code></pre><h1 id="count-records">Count records</h1>
<p><a href='../classes/Query.html#Query__count'>Query::count</a> returns the count of records.</p>
<table class='table table-bordered'><thead><tr>
  <th>CORMO</th><th>SQL</th><th>MongoDB</th>
</tr></thead><tbody>

<tr>
<td>User.count (error, count) -&gt;</td>
<td>SELECT COUNT(*) FROM users</td>
<td>db.users.count()</td>
</tr>

<tr>
<td>User.count age: 27, (error, count) -&gt;</td>
<td rowspan='2'>SELECT COUNT(*) FROM users WHERE age=27</td>
<td rowspan='2'>db.users.find({age: 27}).count()</td>
</tr>
<tr>
<td>User.where(age: 27).count (error, count) -&gt;</td>
</tr>

</tbody></table>

<h1 id="update-records">Update records</h1>
<p>To update records, <a href='../classes/model.ModelPersistence.html#model_ModelPersistence__save'>ModelPersistence::save</a> and <a href='../classes/Query.html#Query__update'>Query::update</a> are provided.</p>
<p><a href='../classes/model.ModelPersistence.html#model_ModelPersistence__save'>ModelPersistence::save</a> is used to update a single retrieved record.</p>
<pre><code class="lang-coffeescript">User.find 1, (error, user) -&gt;
  user.age = 30
  user.save (error) -&gt;
</code></pre>
<p>But <a href='../classes/model.ModelPersistence.html#model_ModelPersistence__save'>ModelPersistence::save</a> has some weaknesses.</p>
<ul>
<li>You must retrieve a record before modification.<ul>
<li>In normal application, retrieved data may not be used usually.</li>
</ul>
</li>
<li>This requires to read all fields from database and send all fields to database.<ul>
<li>If you save projected(<a href='../classes/Query.html#Query__select'>Query::select</a>) record, other fields will set to null.</li>
<li>CORMO has the partial update option(<a href='../classes/Model.html#Model_dirty_tracking'>Model.dirty_tracking</a>). But currently it rather is slow. So it is turned off by default.</li>
</ul>
</li>
</ul>
<p><a href='../classes/Query.html#Query__update'>Query::update</a> updates selected records.</p>
<table class='table table-bordered'><thead><tr>
  <th>CORMO</th><th>SQL</th><th>MongoDB</th>
</tr></thead><tbody>

<tr>
<td>User.update { age: 10 }, age: 27, (error, count) -&gt;</td>
<td rowspan='2'>UPDATE users SET age=10 WHERE age=27</td>
<td rowspan='2'>db.users.update({age: 27}, {age: 10}, {multi: true})</td>
</tr>
<tr>
<td>User.where(age: 27).update age:10, (error, count) -&gt;</td>
</tr>

<tr>
<td>User.find(1).update age: 10, (error, count) -&gt;</td>
<td>UPDATE users SET age=10 WHERE id=1</td>
<td>db.users.update({_id: 1}, {age: 10}, {multi: true})</td>
</tr>

</tbody></table>

<p>But you cannot use other column&#39;s value as data like SQL does on <a href='../classes/Query.html#Query__update'>Query::update</a>.
If you want this, you must retrieve the record first.
But <a href='../classes/Query.html#Query__update'>Query::update</a> may be more efficient than <a href='../classes/model.ModelPersistence.html#model_ModelPersistence__save'>ModelPersistence::save</a> even if in that case.</p>
<pre><code class="lang-coffeescript">User.find 1, (error, user) -&gt;
  age = user.age + 1
  User.find(user.id).update age: age, (error, count) -&gt;
</code></pre>
<h1 id="delete-records">Delete records</h1>
<p><a href='../classes/Query.html#Query__delete'>Query::delete</a> or <a href='../classes/Model.html#Model__destroy'>Model::destroy</a> deletes some records.
<a href='../classes/Model.html#Model__destroy'>Model::destroy</a> is similar to <a href='../classes/Query.html#Query__delete'>Query::delete</a> on the model&#39;s ID.</p>
<table class='table table-bordered'><thead><tr>
  <th>CORMO</th><th>SQL</th><th>MongoDB</th>
</tr></thead><tbody>

<tr>
<td>User.delete age: 27, (error, count) -&gt;</td>
<td rowspan='2'>DELETE FROM users WHERE age=27</td>
<td rowspan='2'>db.users.remove({age: 27})</td>
</tr>
<tr>
<td>User.where(age: 27).delete (error, count) -&gt;</td>
</tr>

<tr>
<td>User.delete (error, count) -&gt;</td>
<td>DELETE FROM users</td>
<td>db.users.remove()</td>
</tr>

</tbody></table></div></div></div><script src="http://code.jquery.com/jquery-1.8.2.min.js"></script><script src="../bootstrap/js/bootstrap.min.js"></script><script src="../google-code-prettify/prettify.js"></script><script>$(function() {
  // make result of marked for pretty print
  $('pre code[class^="lang-"]').addClass('.prettyprint');
  window.prettyPrint && prettyPrint()
});
$('body').on('click', '.showcode', function () {
  $(this).parent().find('pre.sourcecode').toggle();
  $('body').scrollspy('refresh');
});
$('#options-private').on('click', function () {
  $('.private').toggle();
  $('body').scrollspy('refresh');
});</script><script src="http://code.jquery.com/ui/1.9.0/jquery-ui.min.js"></script><script src="../tocify/jquery.tocify.min.js"></script><script>$(function() {
  $('#toc').tocify();
});</script><a href="https://github.com/croquiscom/cormo"><img src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub" class="github-ribbon"></a></body></html>